<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin - SiDuta</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .nav-tabs .nav-link { border: none; color: #64748b; font-weight: 600; }
        .nav-tabs .nav-link.active { color: #005aab; border-bottom: 3px solid #005aab; background: none; }
        .wa-queue-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body style="background: #f8fafc;">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 style="font-weight: 800; color: #002d5c; margin: 0;">Panel Master Admin</h2>
                <p class="text-muted">Monitoring & Penugasan Duta</p>
            </div>
            <a href="index.html" class="btn btn-outline-danger btn-sm" style="border-radius: 10px;">Keluar</a>
        </div>

        <ul class="nav nav-tabs mb-4" id="adminTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-tugas">Tambah Tugas</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-monitor" id="btn-tab-monitor">Monitoring Cloud</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-jadwal">Daftar Jadwal</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-tugas">
                <div class="admin-card">
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h5 class="mb-3">Form Penugasan</h5>
                            <div class="mb-3"><label class="custom-label">Nama Kegiatan</label><input type="text" id="adm-keg" class="form-control-custom"></div>
                            <div class="row mb-3">
                                <div class="col-6"><label class="custom-label">Tanggal</label><input type="date" id="adm-tgl" class="form-control-custom"></div>
                                <div class="col-6"><label class="custom-label">Jam</label><input type="text" id="adm-jam" class="form-control-custom" placeholder="08:00 - Selesai"></div>
                            </div>
                            <div class="mb-3"><label class="custom-label">Lokasi</label><input type="text" id="adm-lok" class="form-control-custom"></div>
                            <div class="mb-3">
                                <label class="custom-label">Pilih Duta (Gunakan CTRL untuk pilih banyak)</label>
                                <select id="adm-select" multiple class="form-control" style="height: 150px; border-radius: 12px;"></select>
                            </div>
                            <button id="btn-post-tugas" onclick="prosesTugas()" class="btn-action-primary" style="width: 100%;">Posting Tugas</button>
                        </div>
                        <div class="col-md-6 px-4">
                            <h5 class="mb-3 text-success"><i class="fa-brands fa-whatsapp"></i> Antrean Broadcast WA</h5>
                            <div id="wa-queue-list" class="text-muted" style="font-size: 13px;">Belum ada penugasan baru...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-monitor">
                <div class="admin-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0">Log Aktivitas Cloud</h5>
                        <button onclick="loadAllHistory()" class="btn btn-sm btn-light"><i class="fa-solid fa-sync"></i> Refresh Data</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table" style="font-size: 13px;">
                            <thead>
                                <tr class="table-light">
                                    <th>Nama Duta</th>
                                    <th>Aksi</th>
                                    <th>Keterangan/Lokasi</th>
                                    <th>Waktu</th>
                                </tr>
                            </thead>
                            <tbody id="log-presensi-all">
                                <tr><td colspan="4" class="text-center text-muted">Klik tab ini untuk memuat data cloud...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-jadwal">
                <div class="admin-card">
                    <h5 class="mb-3">Manajemen Jadwal Terposting</h5>
                    <div id="admin-jadwal-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cek Login Admin
        if (sessionStorage.getItem('isAdmin') !== 'true') window.location.href = "index.html";

        // Render Dropdown Duta
        const sel = document.getElementById('adm-select');
        dutaData.filter(d => d.n !== "Admin Master").forEach(d => {
            const opt = document.createElement('option'); opt.value = d.n; opt.text = d.n; sel.appendChild(opt);
        });

        // 1. FUNGSI AMBIL DATA MONITORING DARI CLOUD (Sesuai Permintaan Anda)
        async function loadAllHistory() {
            const container = document.getElementById('log-presensi-all');
            container.innerHTML = `<tr><td colspan="4" class="text-center py-4"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><br>Menarik data dari Cloud Sheets...</td></tr>`;

            try {
                const response = await fetch(SCRIPT_URL + "?action=getMonitoring");
                const data = await response.json();
                let html = "";

                // Gabungkan dan urutkan data jika perlu, di sini kita render satu per satu
                if (data.presensi) {
                    data.presensi.reverse().forEach(row => {
                        html += `
                            <tr>
                                <td><b>${row[0]}</b></td>
                                <td><span class="badge bg-primary">Presensi</span></td>
                                <td>${row[2]} <br> <a href="${row[4]}" target="_blank" class="text-primary" style="font-size:11px; text-decoration:none;"><i class="fa-solid fa-image"></i> Lihat Foto</a></td>
                                <td>${row[3]}</td>
                            </tr>`;
                    });
                }

                if (data.evidence) {
                    data.evidence.reverse().forEach(row => {
                        html += `
                            <tr>
                                <td><b>${row[0]}</b></td>
                                <td><span class="badge bg-warning text-dark">Evidence</span></td>
                                <td>${row[1]}: ${row[2]} <br> <a href="${row[4]}" target="_blank" class="text-primary" style="font-size:11px; text-decoration:none;"><i class="fa-solid fa-file-lines"></i> Lihat Bukti</a></td>
                                <td>${row[3]}</td>
                            </tr>`;
                    });
                }

                container.innerHTML = html || '<tr><td colspan="4" class="text-center">Belum ada aktivitas terekam di cloud.</td></tr>';
            } catch (error) {
                container.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-4"><i class="fa-solid fa-circle-exclamation fa-2x"></i><br>Gagal terhubung ke Cloud. Pastikan GAS sudah di-deploy sebagai 'Anyone'.</td></tr>`;
            }
        }

        // 2. FUNGSI POSTING TUGAS KE CLOUD
        async function prosesTugas() {
            const keg = document.getElementById('adm-keg').value;
            const tgl = document.getElementById('adm-tgl').value;
            const jam = document.getElementById('adm-jam').value;
            const lok = document.getElementById('adm-lok').value;
            const selected = Array.from(sel.selectedOptions).map(o => o.value);

            if(!keg || !tgl || selected.length === 0) return alert("Lengkapi data!");

            const btn = document.getElementById('btn-post-tugas');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> MENGIRIM...';
            btn.disabled = true;

            try {
                const payload = {
                    category: "Jadwal",
                    kegiatan: keg,
                    tanggal: tgl,
                    jam: jam,
                    lokasi: lok,
                    petugas: selected.join(", "),
                    tipe: "Tugas"
                };

                // Kirim ke Google Sheets (fungsi sendToCloud ada di script.js)
                await sendToCloud(payload);

                // Update lokal untuk riwayat admin
                const custom = JSON.parse(localStorage.getItem('dataJadwalCustom')) || [];
                custom.unshift(payload);
                localStorage.setItem('dataJadwalCustom', JSON.stringify(custom));

                // Siapkan Antrean WA
                const queueList = document.getElementById('wa-queue-list');
                queueList.innerHTML = `<h6>Kirim Notifikasi ke:</h6>`;
                selected.forEach(nama => {
                    const d = dutaData.find(x => x.n === nama);
                    const pesan = `Halo ${d.n}, Anda dapat tugas: *${keg}* pada ${tgl} di ${lok}. Mohon hadir tepat waktu!`;
                    queueList.innerHTML += `
                        <div class="wa-queue-item">
                            <span>${d.n}</span>
                            <a href="https://wa.me/${d.wa}?text=${encodeURIComponent(pesan)}" target="_blank" class="btn btn-success btn-sm"><i class="fa-brands fa-whatsapp"></i> Kirim</a>
                        </div>
                    `;
                });

                loadAdminJadwal();
                alert("BERHASIL!\nTugas telah masuk ke Database Cloud dan Jadwal Duta.");
                document.getElementById('adm-keg').value = "";
                document.getElementById('adm-tgl').value = "";
                document.getElementById('adm-lok').value = "";

            } catch (error) {
                alert("Gagal sinkron ke Cloud. Cek koneksi internet.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function loadAdminJadwal() {
            const custom = JSON.parse(localStorage.getItem('dataJadwalCustom')) || [];
            const container = document.getElementById('admin-jadwal-list');
            container.innerHTML = custom.map((j, index) => `
                <div class="p-3 border rounded-3 mb-2 d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="d-block">${j.kegiatan}</strong>
                        <small>${j.tanggal} | ${j.lokasi} | Petugas: ${j.petugas}</small>
                    </div>
                    <button onclick="hapusJadwal(${index})" class="btn btn-outline-danger btn-sm"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }

        function hapusJadwal(idx) {
            if(confirm("Hapus jadwal ini?")) {
                const custom = JSON.parse(localStorage.getItem('dataJadwalCustom')) || [];
                custom.splice(idx, 1);
                localStorage.setItem('dataJadwalCustom', JSON.stringify(custom));
                loadAdminJadwal();
            }
        }

        // Listener saat tab monitoring diklik
        document.getElementById('btn-tab-monitor').addEventListener('shown.bs.tab', loadAllHistory);

        // Init Data Awal
        loadAdminJadwal();
    </script>
</body>
</html>
